{% extends 'base.html' %}
{% block additional-headers %}
{% load i18n %}
  <!-- a temporary way to hide the kobocat deprecated features -->
  <style type="text/css">
  .kc-hide { display: none !important; }
  </style>

{% endblock %}

{% block content %}
{% load i18n %}

<div class="sub-header-bar">
  <div class="container__wide">
    <a class="sub-header__back" href="{% url "onadata.apps.main.views.show" xform.user.username xform.id_string %}"><i class="fa fa-chevron-left"></i> {% trans "Return to" %} {{ xform.title }}</a>
  </div>
</div>

<header class="data-page__header">
    <hgroup class="container">
      <h1>{{ export_type_name|upper }} {% blocktrans %}Exports{% endblocktrans %}</h1>
    </hgroup>
</header>

<section id="export-downloads">

    {% if user.is_authenticated %}
    <form action="{% url "onadata.apps.viewer.views.create_export" username xform.id_string export_type %}" method="post" enctype="application/x-www-form-urlencoded">
        {% csrf_token %}
            <span style='float:middle;'>
              <div>
                <input type="submit" class="btn btn-primary" value="{% trans 'New Export' %}" />
                {% if export_type == 'xls' or export_type == 'csv' %}
                  <a href="#advanced-export-modal" role="button" class="btn" id="advanced-export-button">{% trans "Advanced Export" %}</a>
                {% endif %}
            </div>
            </span>
    </form>
    {% endif %}

    <div class="kc-hide">
      <div id="advanced-export-modal">
        <div class="vex-header"><h3>{% trans "Advanced Export" %}</h3></div>
        <form action="{% url "onadata.apps.viewer.views.create_export" username xform.id_string export_type %}" method="post" enctype="application/x-www-form-urlencoded">
          {% csrf_token %}
          {% if export_type == 'external' %}
            <label>{% trans "Template to use for the export" %}</label><br/>
            <select id="external_export_metadata" name="meta" class="span2">
              {% for meta in metas %}
              <option value="{{ meta.id }}">{% trans meta.data_value %}</option>
              {% endfor %}
            </select><br/>
          {% else %}
            <label>{% trans "Delimiter to use to separate group names from field names" %}</label><br/>
            <select id="options-group_delimiter" name="options[group_delimiter]" class="span2">
              <option value=".">. ({% trans "Dot" %})</option>
              <option value="/" selected>/ ({% trans "Slash" %})</option>
            </select><br/>
            <label class="checkbox">
              <input type="checkbox" name="options[dont_split_select_multiples]" value="yes" />
              {% trans "DONT split select multiple choice answers into separate columns" %}
            </label><br/>
          {% endif %}
          <a href="#" class="btn vex-close-button">{% trans "Cancel" %}</a>
          <input type="submit" class="btn large btn-primary" value="{% trans "Create Export" %}" />
        </form>
      </div>
    </div>

  <table id="forms-table" class="table table-bordered table-striped">
    <thead>
      <tr>
        <th>#</th>
        <th>{% trans "Filename" %}</th>
        <th>{% trans "Date Created" %}</th>
        <th>{% trans "Delete" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for export in exports %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>
            {% if not export.is_pending %}
                {% if export.is_successful %}
                    <a href="{% url "onadata.apps.viewer.views.export_download" username xform.id_string export.export_type export.filename %}">{{ export.filename }}</a>
                {% else %}
                    Failed
                {% endif %}
            {% else %}
              <span class="status">{% trans "Pending ..." %}</span>
              <a href="#" class="refresh-export-progress" data-role="refresh-export-progress" data-export="{{ export.id|stringformat:"d" }}">{% trans "Click to refresh" %}</a>
            {% endif %}
        </td>
        <td>{{ export.created_on }}</td>
        <td>
          <div class="kc-hide">
            <div id="delete-{{ export.id|stringformat:"d" }}">
              <div class="vex-header"><h3>{% trans "Delete Export" %}</h3></div>
                <form action="{% url "onadata.apps.viewer.views.delete_export" username xform.id_string export_type %}" method="post" enctype="application/x-www-form-urlencoded">
                  {% csrf_token %}
                  <div class="vex-kobo-body">
                    <p>{% trans "Are you sure you want to delete this export?" %}</p>
                    <a href="#" class="btn vex-close-button">{% trans "Cancel" %}</a>
                    <input type="hidden" name="export_id" value="{{ export.id|stringformat:"d" }}">
                    <input type="submit" class="btn btn-primary" value="{% trans 'Delete' %}" />
                  </div>
                </form>
            </div>
          </div>
          <div>
            <a href="#delete-{{ export.id|stringformat:"d" }}" class="delete-button">
                <i class="fa fa-trash-o"></i>
            </a>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

</section>
{% endblock %}

{% block javascript %}
{{ block.super }}
<script type="text/javascript" src="{{STATIC_URL}}js/jquery.dataTables.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/jquery.dataTables.pagination.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/form_actions.js"></script>
<script type="text/javascript" charset="utf-8" src="{{STATIC_URL}}js/underscore-min.js"></script>
<script type="text/javascript" charset="utf-8" src="{{STATIC_URL}}js/export_list.js"></script>
<script type="text/javascript">
    var progress_url = '{% url "onadata.apps.viewer.views.export_progress" username xform.id_string export_type %}';
</script>

<script type="text/javascript">
$(document).ready(function() {

  $(document).on("click", ".delete-button", function () {
    var id = $(this).attr('href');
    var delete_form = $(id);
    vexDelete = vex.open({
      content: delete_form.clone(),
      contentClassName: 'vex-content vex-content-large',
    });
  });

  $(document).on("click", "#advanced-export-button", function () {
    vexRefresh = vex.open({
      content: $('#advanced-export-modal').clone(),
      contentClassName: 'vex-content'
    });
  });

  $(document).on("click", ".vex-close-button", function () {
    vex.closeAll();
  });

});
</script>

{% endblock %}
